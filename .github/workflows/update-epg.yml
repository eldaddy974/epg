name: Update EPG (public, no credentials)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"   # daily at 03:00 UTC

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip lxml

      # ðŸ”§ Edit this list if you want to add/remove countries later
      - name: Prepare list of country feeds
        run: |
          cat > countries.txt << 'EOF'
          fr
          ma
          sa
          qa
          eg
          ae
          ng
          de
          nl
          be
          ch
          at
          dk
          ie
          es
          pt
          it
          tr
          rs
          gb
          us
          ca
          br
          il
          lb
          my
          sg
          EOF
          sed -i '/^\s*$/d' countries.txt
          echo "Countries:" && cat countries.txt

      - name: Download XMLTV sources (best effort)
        run: |
          mkdir -p epg_sources
          while read cc; do
            url="https://raw.githubusercontent.com/iptv-org/epg/master/guides/${cc}.xml"
            echo "Fetching $url"
            if curl -fsSL --retry 3 --retry-delay 3 "$url" -o "epg_sources/${cc}.xml"; then
              echo "OK: $cc"
            else
              echo "WARN: $cc not available, skipping"
            fi
          done < countries.txt
          ls -la epg_sources || true

      - name: Merge XMLTV into epg.xml
        run: |
          python - << 'PY'
          import os
          from lxml import etree

          src_dir = "epg_sources"
          files = [os.path.join(src_dir, f) for f in os.listdir(src_dir) if f.endswith(".xml")]

          root = etree.Element("tv")
          seen_channels = set()

          for f in files:
            try:
              tv = etree.parse(f).getroot()
            except Exception as e:
              print("Skipping invalid:", f, e)
              continue

            for ch in tv.findall("channel"):
              cid = ch.get("id")
              if cid and cid not in seen_channels:
                root.append(ch)
                seen_channels.add(cid)

            for pr in tv.findall("programme"):
              root.append(pr)

          with open("epg.xml", "wb") as out:
            out.write(etree.tostring(root, xml_declaration=True, encoding="UTF-8"))

          print("Merged channels:", len(seen_channels), "from", len(files), "files")
          PY

      - name: Commit epg.xml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add epg.xml
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update public EPG"
            git push
          fi
